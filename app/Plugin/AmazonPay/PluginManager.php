<?php
/*   __________________________________________________
    |  Obfuscated by YAK Pro - Php Obfuscator  2.0.3   |
    |              on 2020-11-16 14:57:02              |
    |    GitHub: https://github.com/pk-fr/yakpro-po    |
    |__________________________________________________|
*/
namespace Plugin\AmazonPay;use Symfony\Component\Filesystem\Filesystem;use Symfony\Component\DependencyInjection\ContainerInterface;use Eccube\Plugin\AbstractPluginManager;use Eccube\Common\Constant;use Eccube\Entity\Payment;use Eccube\Entity\PaymentOption;use Eccube\Entity\Page;use Eccube\Entity\PageLayout;use Eccube\Entity\Csv;use Eccube\Repository\BaseInfoRepository;use Eccube\Repository\PageRepository;use Eccube\Repository\LayoutRepository;use Eccube\Repository\PageLayoutRepository;use Eccube\Repository\PaymentRepository;use Eccube\Repository\DeliveryRepository;use Eccube\Repository\Master\CsvTypeRepository;use Eccube\Repository\CsvRepository;use Plugin\AmazonPay\Entity\Master\AmazonStatus;use Plugin\AmazonPay\Entity\Config;use Plugin\AmazonPay\Form\Type\Master\ConfigTypeMaster as Master;use Plugin\AmazonPay\Service\Method\AmazonPay;use Eccube\Repository\PluginRepository;use Eccube\Service\PluginService;class PluginManager extends AbstractPluginManager{public function __construct(){goto M1zhh;XEwBt:$this->origin_css = __DIR__ . '/Resource/copy/css';goto AOnQv;AOnQv:$this->target_html = __DIR__ . '/../../..';goto KCtuY;KCtuY:$this->target_css = __DIR__ . '/../../../html/template/default/assets/css';goto ZEF7m;M1zhh:$this->origin_html = __DIR__ . '/Resource/copy/html';goto XEwBt;ZEF7m:$this->target_user_data = __DIR__ . '/../../../html/user_data';goto JltRX;JltRX:}public function install(array $config, ContainerInterface $container){goto Q8bsI;EpYYD:$this->setConfigIni();goto rqu2r;rqu2r:$this->sendAutoMail($container, 'インストール');goto FAkpZ;Q8bsI:$this->copyAssets($container);goto EpYYD;FAkpZ:}public function enable(array $config, ContainerInterface $container){goto KeWgs;HTJb0:$this->createPlgAmazonPayConfig($container);goto ikEAo;lfG2s:$PluginService->generateProxyAndUpdateSchema($Plugin, $config);goto QYbiZ;AVe1v:$Plugin = $PluginRepository->findByCode('AmazonPay');goto lfG2s;JWXSH:$this->createAmazonPage($container);goto HTJb0;ikEAo:$this->createPlgAmazonPayStatus($container);goto pY1Lt;TvrTy:$this->createConfigCsv($container);goto JWXSH;Cs_xk:$PluginService = $container->get('Eccube\\Service\\PluginService');goto AVe1v;KeWgs:$PluginRepository = $container->get('Eccube\\Repository\\PluginRepository');goto Cs_xk;QYbiZ:$this->createAmazonPay($container);goto TvrTy;pY1Lt:}public function disable(array $config, ContainerInterface $container){$this->disableAmazonPay($container);}public function uninstall(array $config, ContainerInterface $container){$this->removeAssets($container);$this->sendAutoMail($container, '削除');}public function update(array $config, ContainerInterface $container){$this->updateAssets($container);}private function createAmazonPay(ContainerInterface $container){goto uauIm;YSCUE:KRgbQ:goto bDtBU;G1jFI:return;goto f1cPH;dQY_q:$Payment->setSortNo($sortNo);goto eVJ1V;uekUF:$Payment->setRuleMin(0);goto p3qRv;fwehN:$Payment->setVisible(true);goto wQM9Q;smmZk:$Payment->setCharge(0);goto dQY_q;V362x:$Payment->setMethodClass(AmazonPay::class);goto uekUF;BhZ3s:$paymentRepository = $container->get(PaymentRepository::class);goto pAZNc;xwHBl:$sortNo = $Payment ? $Payment->getSortNo() + 1 : 1;goto jyU0f;p3qRv:$entityManage->persist($Payment);goto St3LB;jyU0f:$Payment = new Payment();goto smmZk;uauIm:$entityManage = $container->get('doctrine.orm.entity_manager');goto BhZ3s;nw9cN:$deliveryRepository = $container->get(DeliveryRepository::class);goto J18Gb;St3LB:$entityManage->flush($Payment);goto nw9cN;wQM9Q:$entityManage->flush($Payment);goto G1jFI;alJ8t:$Payment = $paymentRepository->findOneBy([], ['sort_no' => 'DESC']);goto xwHBl;J18Gb:$Deliveries = $deliveryRepository->findAll();goto E66i3;pAZNc:$Payment = $paymentRepository->findOneBy(['method_class' => AmazonPay::class]);goto jcDjL;f1cPH:VoCJZ:goto alJ8t;DKIr4:$Payment->setMethod('AmazonPay');goto V362x;jcDjL:if (!$Payment) {goto VoCJZ;}goto fwehN;E66i3:foreach ($Deliveries as $Delivery) {goto LQ4m3;cHlwe:$PaymentOption->setDeliveryId($Delivery->getId());goto mQxa_;LQ4m3:$PaymentOption = new PaymentOption();goto WHzbE;gFmtL:$entityManage->persist($PaymentOption);goto c55ID;WHzbE:$PaymentOption->setDelivery($Delivery);goto cHlwe;c55ID:$entityManage->flush($PaymentOption);goto M6wm5;mQxa_:$PaymentOption->setPayment($Payment);goto sFzVh;M6wm5:AE80P:goto CnbyJ;sFzVh:$PaymentOption->setPaymentId($Payment->getId());goto gFmtL;CnbyJ:}goto YSCUE;eVJ1V:$Payment->setVisible(true);goto DKIr4;bDtBU:}private function disableAmazonPay(ContainerInterface $container){goto irl82;z_xZS:if (!$Payment) {goto Pe6Io;}goto fKQur;irl82:$entityManage = $container->get('doctrine.orm.entity_manager');goto MLsCH;moiMe:$entityManage->flush($Payment);goto i3ga5;i3ga5:Pe6Io:goto avN7v;MLsCH:$paymentRepository = $container->get(PaymentRepository::class);goto pR1bh;pR1bh:$Payment = $paymentRepository->findOneBy(['method_class' => AmazonPay::class]);goto z_xZS;fKQur:$Payment->setVisible(false);goto moiMe;avN7v:}private function createConfigCsv(ContainerInterface $container){goto bUcUv;IyeTc:$arrCsv = [['entity_name' => 'Eccube\\Entity\\Order', 'field_name' => 'reference_code', 'reference_field_name' => null, 'disp_name' => 'Amazon参照ID'], ['entity_name' => 'Eccube\\Entity\\Order', 'field_name' => 'AmazonStatus', 'reference_field_name' => 'name', 'disp_name' => 'Amazon状況']];goto BVU1G;EPDXl:$LastCsv = $csvRepository->findOneBy(['CsvType' => $OrderCsvType], ['sort_no' => 'DESC']);goto CWesr;ytdt1:RMsmR:goto L6B07;BVU1G:foreach ($arrCsv as $c) {goto z4qFq;PK08z:$Csv->setDispName($c['disp_name']);goto Hcdut;uNs2r:if (!$Csv) {goto BgvPd;}goto ZXAnx;guosY:$Csv->setCreateDate(new \DateTime());goto KMxdp;FXEXX:$Csv->setReferenceFieldName($c['reference_field_name']);goto PK08z;HYOTK:$Csv = new Csv();goto x3kws;KMxdp:$Csv->setUpdateDate(new \DateTime());goto nrLvM;MSiPH:x7o1h:goto NUbXJ;nrLvM:$entityManage->persist($Csv);goto bVEYC;g4o5Y:BgvPd:goto HYOTK;bVEYC:$entityManage->flush($Csv);goto MSiPH;x3kws:$Csv->setCsvType($OrderCsvType);goto td2mC;ZXAnx:goto x7o1h;goto g4o5Y;z4qFq:$Csv = $csvRepository->findOneBy(['disp_name' => $c['disp_name']]);goto uNs2r;Hcdut:$Csv->setSortNo($sortNo++);goto guosY;td2mC:$Csv->setEntityName($c['entity_name']);goto Jupmr;Jupmr:$Csv->setFieldName($c['field_name']);goto FXEXX;NUbXJ:}goto ytdt1;WrhET:$csvRepository = $container->get(CsvRepository::class);goto EPDXl;CWesr:$sortNo = $LastCsv->getSortNo();goto IyeTc;zhx8f:$OrderCsvType = $csvTypeRepository->find(3);goto WrhET;bUcUv:$entityManage = $container->get('doctrine.orm.entity_manager');goto S6X3H;S6X3H:$csvTypeRepository = $container->get(CsvTypeRepository::class);goto zhx8f;L6B07:}private function createAmazonPage(ContainerInterface $container){goto yJGFv;LKcAW:foreach ($arrPage as $p) {goto F8nHx;eSmO4:$Page->setFileName($p['file_name']);goto YBp2m;PE26F:$Page->setUrl($p['url']);goto eSmO4;QB_9Q:$entityManage->flush($Page);goto lM28N;HgASF:goto MxTa7;goto c_bhl;yiFvn:$Page->setName($p['page_name']);goto PE26F;ruG_j:$Page->setMetaRobots('noindex');goto AVeFa;tI07a:$Page = new Page();goto yiFvn;c_bhl:icXsu:goto tI07a;PSx6_:$PageLayout->setPageId($Page->getId());goto h3ciZ;AVeFa:$entityManage->persist($Page);goto QB_9Q;lM28N:$PageLayout = new PageLayout();goto dHnJf;B8qR5:$Page->setUpdateDate(new \DateTime());goto ruG_j;F8nHx:$Page = $pageRepository->findOneBy(['url' => $p['url']]);goto k5YwB;YBp2m:$Page->setEditType(Page::EDIT_TYPE_DEFAULT);goto Obgtv;U42BB:MxTa7:goto VtRy_;Obgtv:$Page->setCreateDate(new \DateTime());goto B8qR5;cb6RC:$entityManage->persist($PageLayout);goto ae5nw;dHnJf:$PageLayout->setPage($Page);goto PSx6_;h3ciZ:$PageLayout->setLayout($Layout);goto yglZl;Y6PrG:$PageLayout->setSortNo($sortNo++);goto cb6RC;ae5nw:$entityManage->flush($PageLayout);goto U42BB;k5YwB:if (!$Page) {goto icXsu;}goto HgASF;yglZl:$PageLayout->setLayoutId($Layout->getId());goto Y6PrG;VtRy_:}goto hNIcJ;qkv_6:$arrPage = [['page_name' => '商品購入(AmazonPay)', 'url' => 'amazon_shopping', 'file_name' => 'Shopping/index'], ['page_name' => '商品購入(AmazonPay)/ご注文確認', 'url' => 'amazon_shopping_confirm', 'file_name' => 'Shopping/confirm']];goto LKcAW;yJGFv:$entityManage = $container->get('doctrine.orm.entity_manager');goto dh9Le;AFKSs:$Layout = $layoutRepository->find(2);goto pL51l;hNIcJ:spx4b:goto w33kF;pL51l:$pageLayoutRepository = $container->get(PageLayoutRepository::class);goto rmeKk;dh9Le:$pageRepository = $container->get(PageRepository::class);goto fopcd;rmeKk:$LastPageLayout = $pageLayoutRepository->findOneBy([], ['sort_no' => 'DESC']);goto OypkD;OypkD:$sortNo = $LastPageLayout->getSortNo();goto qkv_6;fopcd:$layoutRepository = $container->get(LayoutRepository::class);goto AFKSs;w33kF:}public function createPlgAmazonPayConfig(ContainerInterface $container){goto dnoGj;dqjoP:$Config->setCartButtonSize('large');goto CWK2O;ZV5KS:$Config->setDelivWidgetHeight(260);goto KL11K;PXDK4:$Config->setOrderCorrect(true);goto RwtFO;FXCya:$amazonPayEnvs = $container->getParameter('amazon_pay')['env'];goto NP0uE;dnoGj:$entityManage = $container->get('doctrine.orm.entity_manager');goto QRZIX;A8bKa:$Config->setEnv(1);goto H7LSO;mJRWM:$Config->setUseCartButton(true);goto FVzI_;LONni:$Config->setEnv(Master::ENV['SANDBOX']);goto I90Gm;Yy4PE:$entityManage->persist($Config);goto f0dG3;u5kOt:mp187:goto vYwwH;FyM4z:$Config->setPaymentWidgetHeight(260);goto yaFNf;wK8ml:$Config->setMypageChangeButtonPlace(1);goto sNPY3;l5iZr:$Config->setMypageLoginButtonPlace(1);goto ZV5KS;gp8Rf:if (!$Config) {goto XjGJJ;}goto FXCya;hdSVH:$Config->setProductsButtonColor('Gold');goto IHxjo;H7LSO:$Config->setAmazonAccountMode(1);goto YNxAk;MzgXU:$Config = new Config();goto W7mEH;QRZIX:$Config = $entityManage->find(Config::class, 1);goto gp8Rf;tE6kx:hzRHp:goto SVpVI;c43FD:$Config->setMypageChangeButtonColor('Gold');goto Je0NY;NP0uE:if (in_array($Config->getEnv(), $amazonPayEnvs)) {goto mp187;}goto A8bKa;FVzI_:$Config->setCartButtonColor('Gold');goto dqjoP;sNPY3:$Config->setUseMypageLoginButton(false);goto A0SqO;Je0NY:$Config->setMypageChangeButtonSize('large');goto wK8ml;RwtFO:$Config->setMailNotices(null);goto mJRWM;mXlpH:$Config->setAutoLogin(true);goto T0EUw;YNxAk:goto hzRHp;goto u5kOt;DD71h:$Config->setUseConfirmPage(false);goto mXlpH;ZuG0V:$Config->setProductsButtonPlace(Master::PRODUCTS_BUTTON_PLACE['AUTO']);goto bzETm;bzETm:$Config->setUseMypageChangeButton(false);goto c43FD;zKWfH:return;goto bnPJt;SVpVI:$entityManage->flush();goto zKWfH;yaFNf:$Config->setPaymentWidgetWidth(330);goto Yy4PE;KL11K:$Config->setDelivWidgetWidth(330);goto FyM4z;I90Gm:$Config->setSale(Master::SALE['AUTORI']);goto DD71h;vYwwH:$Config->setAmazonAccountMode(2);goto tE6kx;BXUwX:$Config->setMypageLoginButtonSize('large');goto l5iZr;f0dG3:$entityManage->flush($Config);goto QFfkF;T0EUw:$Config->setLoginRequired(false);goto PXDK4;A0SqO:$Config->setMypageLoginButtonColor('Gold');goto BXUwX;W7mEH:$Config->setAmazonAccountMode(Master::ACCOUNT_MODE['SHARED']);goto LONni;CWK2O:$Config->setCartButtonPlace(Master::CART_BUTTON_PLACE['AUTO']);goto MhUdv;IHxjo:$Config->setProductsButtonSize('large');goto ZuG0V;bnPJt:XjGJJ:goto MzgXU;MhUdv:$Config->setUseProductsButton(true);goto hdSVH;QFfkF:}public function createPlgAmazonPayStatus(ContainerInterface $container){goto uuPFU;uuPFU:$entityManage = $container->get('doctrine.orm.entity_manager');goto Mwic3;tv_pb:$i = 0;goto rNPkO;guGk2:SNCgC:goto i1Ou9;rNPkO:foreach ($statuses as $id => $name) {goto Fk2wk;D5pSf:$entityManage->flush($AmazonStatus);goto zjizB;v2Q4_:avVi1:goto aSgdW;zjizB:Kt11_:goto ADLCg;aSgdW:$AmazonStatus = new AmazonStatus();goto f2fkl;dHQsx:$AmazonStatus->setSortNo($i++);goto qiK6K;r0ckQ:if (!$AmazonStatus) {goto avVi1;}goto eN6rL;Fk2wk:$AmazonStatus = $entityManage->find(AmazonStatus::class, $id);goto r0ckQ;f2fkl:$AmazonStatus->setId($id);goto xT0QE;eN6rL:goto Kt11_;goto v2Q4_;xT0QE:$AmazonStatus->setName($name);goto dHQsx;qiK6K:$entityManage->persist($AmazonStatus);goto D5pSf;ADLCg:}goto guGk2;Mwic3:$statuses = [AmazonStatus::AUTHORI => 'オーソリ', AmazonStatus::CAPTURE => '売上', AmazonStatus::CANCEL => '取消'];goto tv_pb;i1Ou9:}private function copyAssets(ContainerInterface $container){goto k7LBx;k7LBx:$file = new Filesystem();goto Gef8b;VK1XZ:$file->mirror($this->origin_css, $this->target_css);goto qirLH;c1odP:$file->mkdir($this->target_css);goto VK1XZ;Gef8b:$this->copyHtml($container, $file);goto c1odP;qirLH:}private function removeAssets(ContainerInterface $container){goto Hp_Cl;pGMtQ:$this->removeHtml($container, $file);goto OnLiO;Hp_Cl:$file = new Filesystem();goto pGMtQ;OnLiO:$file->remove($this->target_css . 'amazon_shopping.css');goto fKmSH;fKmSH:}private function updateAssets(ContainerInterface $container){goto zNGIN;Y6gil:$eccubePlatform = env('ECCUBE_PLATFORM');goto lh2Uf;KcM80:$file->copy($this->origin_html . '/amazon_login.html', $this->target_html . '/amazon_login.html');goto biDkF;zNGIN:$file = new Filesystem();goto Y6gil;Tvb5C:if ($file->exists($this->target_html . '/amazon_login.html')) {goto wc0t7;}goto KcM80;bQ5BS:JCalD:goto Bz0sx;lh2Uf:if ($eccubePlatform === 'ec-cube.co') {goto oyFVo;}goto Tvb5C;r3ZuD:$file->copy($this->origin_html . '/amazon_login.html', $this->target_user_data . '/amazon_login.html');goto bQ5BS;biDkF:wc0t7:goto wraqh;wraqh:goto lEdrj;goto LX0sY;LX0sY:oyFVo:goto mInQt;Bz0sx:lEdrj:goto k7cdl;mInQt:if ($file->exists($this->target_user_data . '/amazon_login.html')) {goto JCalD;}goto r3ZuD;k7cdl:}public function sendAutoMail($container, $process){goto C6vtK;c6272:$transport = $container->get('swiftmailer.mailer.default.transport.real');goto i_a3t;u6rFJ:if (!(isset($_SERVER['HTTP_HOST']) && isset($_SERVER['REQUEST_URI']))) {goto lN3OF;}goto uu1yE;miolx:$url = substr($url, 0, strrpos($url, 'store') - 1);goto k0Y28;clpm5:$BaseInfo = $baseInfoRepository->get();goto yQtI9;uu1yE:$url = "http://" . $_SERVER["HTTP_HOST"] . $_SERVER['REQUEST_URI'];goto miolx;kPy6B:$message->setSubject('[' . $BaseInfo->getShopName() . '] ' . 'プラグイン' . $process . '処理のお知らせ【AmazonPay】')->setFrom([$BaseInfo->getEmail03() => $BaseInfo->getShopName()])->setTo(['amazon@iplogic.co.jp' => 'amazon'])->setBody($body);goto c6272;cqVPG:lN3OF:goto CwD35;C6vtK:$baseInfoRepository = $container->get(BaseInfoRepository::class);goto clpm5;yQtI9:$url = '';goto u6rFJ;tsYYh:$mailer->send($message);goto D_76g;qU115:        $body = <<<__EOS__
AmazonPay プラグインサポート各位

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■　プラグイン{$process}のお知らせ　■
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

以下のECサイトでAmazonPay プラグインが{$process}されました。

【店名】{$BaseInfo->getShopName()}
【EC-CUBE】{$version}
【URL】{$url}
【メールアドレス】{$BaseInfo->getEmail01()}
【処理日時】{$datetime}


※本メールは、配信専用です。
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
AmazonPay　プラグインサポート
URL：https://www.iplogic.co.jp/lp/amazon_payments.html
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
__EOS__;
goto QuMV_;i_a3t:$mailer = new \Swift_Mailer($transport);goto tsYYh;k0Y28:$url = substr($url, 0, strrpos($url, '/') + 1);goto cqVPG;QuMV_:$message = new \Swift_Message();goto kPy6B;CwD35:$datetime = date('Y-m-d H:i:s');goto vDl0w;vDl0w:$version = Constant::VERSION;goto qU115;D_76g:}private function copyHtml(ContainerInterface $container, Filesystem $file){goto OhpH0;OhpH0:$eccubePlatform = env('ECCUBE_PLATFORM');goto WROSO;zXr0m:$file->mirror($this->origin_html, $this->target_html);goto rNCaf;rNCaf:goto RUGdq;goto jWDc0;vpoDx:RUGdq:goto sE8qr;WROSO:if ($eccubePlatform === 'ec-cube.co') {goto wB2Dw;}goto zXr0m;VD3t_:$file->mirror($this->origin_html, $this->target_user_data);goto vpoDx;jWDc0:wB2Dw:goto VD3t_;sE8qr:}private function removeHtml(ContainerInterface $container, Filesystem $file){goto k8rpt;sZtTH:$file->remove($this->target_html . '/amazon_login.html');goto aP6I3;ny25k:$file->remove($this->target_user_data . '/amazon_login.html');goto BAYQH;D2jau:if ($eccubePlatform === 'ec-cube.co') {goto GNWZ_;}goto B4ZG0;aP6I3:goto QLxhM;goto t3gq9;k8rpt:$eccubePlatform = env('ECCUBE_PLATFORM');goto D2jau;B4ZG0:$file->remove($this->target_html . '/amazon_relay.html');goto sZtTH;t3gq9:GNWZ_:goto kPq7A;BAYQH:QLxhM:goto s0M_x;kPq7A:$file->remove($this->target_user_data . '/amazon_relay.html');goto ny25k;s0M_x:}private function setConfigIni(){goto ko8cR;gOxfZ:$rand = \Eccube\Util\StringUtil::random();goto YkMxP;Fgyti:if ($eccubePlatform === 'ec-cube.co') {goto KQV06;}goto iIBbZ;YkMxP:file_put_contents(__DIR__ . '/amazon_pay_config.ini', "prefix = '{$rand}'");goto f9x6w;ko8cR:$eccubePlatform = env('ECCUBE_PLATFORM');goto Fgyti;iIBbZ:return;goto gJlNP;gJlNP:KQV06:goto gOxfZ;f9x6w:}}